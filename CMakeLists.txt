cmake_minimum_required(VERSION 3.16)
project(lptcpp)

option(BUILD_CPP "Build the C++ Library" OFF)
option(BUILD_PYTHON "Build the Python Library" OFF)

message(STATUS ${CMAKE_BUILD_TYPE})
if (${CMAKE_BUILD_TYPE} STREQUAL "Debug")
    set(DEBUG ON)
else ()
    set(DEBUG OFF)
endif ()

find_package(MPI REQUIRED)
find_package(HDF5 REQUIRED COMPONENTS CXX)
find_package(Eigen3 3.3 REQUIRED NO_MODULE)
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if (${BUILD_PYTHON})
    find_package(Python REQUIRED COMPONENTS Interpreter Development)
    set(PYTHON_EXECUTABLE ${Python_EXECUTABLE})
    find_package(pybind11 REQUIRED)
    set(PYBIND11_CPP_STANDARD -std=c++14)
endif ()

if (${DEBUG})
    find_package(Catch2 2 REQUIRED)
endif ()

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -W -Wall -Wextra -pedantic -march=native")
set(CMAKE_CXX_COMPILE_FLAGS "${CMAKE_CXX_COMPILE_FLAGS} ${MPI_COMPILE_FLAGS} ")
set(CMAKE_CXX_LINK_FLAGS "${CMAKE_CXX_LINK_FLAGS} ${MPI_LINK_FLAGS}")
set(CMAKE_CXX_COMPILER ${MPI_CXX_COMPILER})

if (${BUILD_PYTHON})
    message(STATUS "Building Python library...")
    pybind11_add_module(pylpt_cpp src/pythonLPT/cpp/bindings.cpp)
    target_include_directories(pylpt_cpp PUBLIC SYSTEM ${MPI_CXX_INCLUDE_PATH} ${HDF5_INCLUDE_DIRS} ${PYTHON_INCLUDE_DIRS})
    target_link_libraries(pylpt_cpp PUBLIC ${MPI_CXX_LIBRARIES} ${HDF5_LIBRARIES} Eigen3::Eigen)
    target_compile_definitions(pylpt_cpp PUBLIC ${HDF5_DEFINITIONS})
endif()

if (${BUILD_CPP} OR ${DEBUG})
    add_library(lptcpp_lib src/pythonLPT/cpp/particlesolver.cpp src/pythonLPT/cpp/particlesolver.h src/pythonLPT/cpp/particle.cpp src/pythonLPT/cpp/particle.h src/pythonLPT/cpp/particlelist.cpp src/pythonLPT/cpp/particlelist.h src/pythonLPT/cpp/mesh.cpp src/pythonLPT/cpp/mesh.h src/pythonLPT/cpp/coordinate.h)
    target_include_directories(lptcpp_lib PUBLIC SYSTEM ${MPI_CXX_INCLUDE_PATH} ${HDF5_INCLUDE_DIRS} ${PYTHON_INCLUDE_DIRS})
    target_link_libraries(lptcpp_lib PUBLIC ${MPI_CXX_LIBRARIES} ${HDF5_LIBRARIES} Eigen3::Eigen)
    target_compile_definitions(lptcpp_lib PUBLIC ${HDF5_DEFINITIONS})
endif ()

if (${DEBUG})
    add_executable(lptcpp_test test/test_base.cpp test/test_particle.cpp)
    target_link_libraries(lptcpp_test lptcpp_lib Catch2::Catch2)
    target_include_directories(lptcpp_test PUBLIC src )
endif ()